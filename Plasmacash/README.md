
# Plasma Cash Chain

Author: Michael Chung (michael@wolk.com)

## Background

A reference Plasma Cash rootchain contract implementation by @wolkinc. To get started, please read:

* [Learn Plasma](https://www.learnplasma.org/)

* [Plasma Cash Simple Spec](https://karl.tech/plasma-cash-simple-spec/)

* [Plasma Cash: Plasma with much less user data checking](https://ethresear.ch/t/plasma-cash-plasma-with-much-less-per-user-data-checking/1298)

* [Plasma Cash with Sparse Merkle Trees and Bloom filters](https://ethresear.ch/t/plasma-cash-with-sparse-merkle-trees-bloom-filters-and-probabilistic-transfers/2006)

Note: in our implementation, probabilistic transfers has been replaced with {allowance, spent, balance} to enable partial transfer and network fee.

## Resources

* [RootContract](https://rinkeby.etherscan.io/address/0x31dbfc0b2fa2f649c23d45f52408ce1189f52b35#readContract): Link to our feature-complete plasmacash-mvp contract on Rinkeby

* [wolk-Plasma](https://github.com/wolkdb/plasma): A separate repository to our Go-based plasma Chain (*code will be made public after security auditing*)

* [swarmdb](https://github.com/wolkdb/swarmdb): Main repository to our decentralized database v0.1 release

* [API](https://docs.wolk.com/): documentation of exposed swarmdb API interface

## Simulations

* [Vanilla case](https://gist.githubusercontent.com/mkchungs/abd4f5cec5410e1d934c5707536c4a63/raw/2483c427d2d2b445e14e8ca789a928ff45858e30/simlog.txt): A 20 block, 5s per block sample simulation log can be found here. "Smart Exit Proof" is automatically generated by operator and returned by JSON-RPC call

* [FaultyTx](https://github.com/wolkdb/deepblockchains/pull/2): Fixed. Simulation not available.

* Reorg Case: TBA

## Deep BlockChains
We have augmented Plasma to support the *Deep BlockChains Architecture* described in this [paper](https://github.com/wolkdb/deepblockchains/blob/master/Deep_Blockchains.pdf). Currently, we are exploring a generalized "plasma debit" implementation, where network fees can flow between token owner and operator; In particular, we are extending the original {deposit, exit} schemes with partial withdraw functionality, which will enable operator to withdraw fees without forcing users to exist tokens on the mainNet.

Most significantly, we have made our plasma both stateful and stateless!

## Contract Interface

* [PlasmaTx Debug Tool](https://rinkeby.etherscan.io/address/0x6031cb0df4f300d53f7256e818af51f0243a354f#readContract): This library handles rlp txhash and verifies a transaction's validity by checking (1) recipient matches with depositor when prevBlock is 0 or (2) signer matches with prevOwner otherwise. Additional helper functions have been provided in this contract but not used in production code.  

* [SparseMerkle Tree](https://rinkeby.etherscan.io/address/0xda4d188831b6c67140cefec35f540bacd87ba526#readContract): This contract is implemented based on [succinct sparse merkle proof format](https://ethresear.ch/t/plasma-cash-with-sparse-merkle-trees-bloom-filters-and-probabilistic-transfers) we published on ethresearch.


## Events on MainNet: Deposits, Exits, and Challenges

We define plasma nodes as a set of nodes that are responsible of (1) monitoring events {`Deposits`, `Exits`, `Challenges`} happening on RootChain contract and recording those state changes on Plasma (2) accepting RPC requests for tokenID transfers on Plasma Chain. Among all nodes, one "main" node and multiple "stand-by" nodes are strategically selected as "Leader" group with additional responsibilities of publishing block info {Sparse Merkle Root, BloomFilter Hash} periodically on the RootChain contract.

Generally speaking, plasma nodes are required to be online at all time and watch any incoming RootChain event using Web Socket; if a plasma node temporarily went offline and wants to rejoin the network, it must catch up to the latest state on MainNet by retrieving all the missing past events via RPC calls with filter options.  A list of event classes that need responding to are:

* `PublishedBlock`: events generated by Plasma Leader calling `submitBlock(blockNumber, merkleRoot Hash)`. Every PublishedBlock event includes the `currentDepositIndex` at given blockNumber, which can be used by plasma nodes to filter a list of unprocessed deposits on plasma chain.  

* `Deposit`: events generated by users depositing ETH(WLK) into RootChain contract. Plasma nodes call `initDeposit()` on plasma chain and sign-off valid tokenIDs to the depositors. Periodically, a plasma block containing all RootChain `deposit()` and all token transfers occurred on plasma chain _*since last published block*_ should be minted, resulting in a new `submitBlock` call by the Plasma Leader.

* `StartExit` and `DepositExit`: events generated by users trying to withdraw tokenIDs they claim to have ownership for. Malicious/frivolous exits can be immediately challenged by the anyone, while valid exits should result in a plasma node subsequently responding with the tokenID as being _untransferrable_ in a `sendPlasmaTransaction` call.

* `ChallengeExit`: ChallengeExit currently _does not_ have any event. A valid challenge remove the tokenID from pending exitsQueue made by illegitimate owner; restrictions on such token be immediately lifted. e.g. marking the tokenID _transferrable_ in a `sendPlasmaTransaction` call.  

* `FinalizeExit`: all tokens finalized can be taken out of circulation completely; the plasma node should respond with the tokenID as being _exited_

# Plasma Node
Pre-build plasma binary can be found on our website [TBA]. Alternatively, you can build plasma binary from the source:
```
# Build plasma binary
$ make plasma
build/env.sh go run build/ci.go install ./cmd/plasma
>>> /usr/local/go/bin/go install -ldflags -X main.gitCommit=fdc5f7b81073c35f1fd36efe4f6ca1c0f2f4f0a6 -s -v ./cmd/plasma
Done building.
Run "./build/bin/plasma" to launch plasma.
```

To start plasma nodes:
```
# Run POA plasma node, starting RPC services at port 8502
$ ./build/bin/plasma --datadir /tmp/datadir3 --plasma.datadir /tmp/plasma3 --port 30303  --verbosity 4 --rpc --rpcaddr "localhost" --rpcport 8502 --rpcapi "personal,db,eth,net,web3,swarmdb,plasma"

# [Optional] Run multiple plasma nodes, peer with master, neighbors, etc.
$ ./build/bin/plasma --datadir /tmp/datadir4 --plasma.datadir /tmp/plasma4 --port 30304  --verbosity 4
$ ./build/bin/plasma --datadir /tmp/datadir5 --plasma.datadir /tmp/plasma5 --port 30305  --verbosity 4
$ ./build/bin/plasma --datadir /tmp/datadir6 --plasma.datadir /tmp/plasma6 --port 30306  --verbosity 4
$ ./build/bin/plasma --datadir /tmp/datadir7 --plasma.datadir /tmp/plasma7 --port 30307  --verbosity 4

# [experimental] use --raft flag to run start a permissioned network

# If successful, the node will start off with some sample deposits
Deposit:  TokenID b437230feb2d24db | Denomination 1000000000000000000 | DepositIndex 0  (Depositor: 0xA45b77a98E2B840617e2eC6ddfBf71403bdCb683, TxHash: 0x75e0a5931a9bbcca8f307aabc08e9e452d08e740a02fc1734e6985e62ce95b8b)
Deposit:  TokenID 37b01bd3adfc4ef3 | Denomination 1000000000000000000 | DepositIndex 1  (Depositor: 0x82Da88C31E874C678D529ad51E43De3A4BAF3914, TxHash: 0x5b61f8311258e43fcb0f62ceba463a65d0c70f574956f91d197c1e2fcf1ddbc2)
Deposit:  TokenID b76883d225414136 | Denomination 2000000000000000000 | DepositIndex 2  (Depositor: 0x3088666E05794d2498D9d98326c1b426c9950767, TxHash: 0xfba309f78744708016b3b5a8d671ee6304450669e08ec32359e571e08a469ab7)
Deposit:  TokenID 9af84bc1208918b  | Denomination 3000000000000000000 | DepositIndex 3  (Depositor: 0xBef06CC63C8f81128c26efeDD461A9124298092b, TxHash: 0xcf44df93b0d3d3f72cb3ccfbc5287270d6cfc8e7753c8bfd2453712924796e9c)
Deposit:  TokenID 7c00dfa72e8832ed | Denomination 4000000000000000000 | DepositIndex 4  (Depositor: 0x74f978A3E049688777E6120D293F24348BDe5fA6, TxHash: 0xaec9f6679e1ef9658bb852053c7ad35962641bb05e639e6fc582e6d8fae1c218)
...
```
*Note*: [wolk-Plasma core](https://github.com/wolkdb/plasma) backend are yet to be released after security audit.

## RPC Interface
Plasma node serves its users via JSON-RPC 2.0. Most Plasma APIs can be tested either directly in the console or via RPC-over-HTTP. To get started, we recommend using the console, as it allows relaxed input types (where both Integers and HexString are accepted), whereas RPC-over-HTTP requires strict HexString due to the [gencodec]("https://github.com/fjl/gencodec") package we are currently using.

```
# Launch console
$ ./build/bin/plasma attach ~/Library/Ethereum/plasmachain.ipc
> plasma
{
    getAnchor: function(),
    getAnchorTransactionPool: function(),
    getChunk: function(),
    getPlasmaBalance: function(),
    getPlasmaBlock: function(),
    getPlasmaBloomFilter: function(),
    getPlasmaToken: function(),
    getPlasmaTransactionPool: function(),
    getPlasmaTransactionReceipt: function(),
    sendAnchorTransaction: function(),
    sendPlasmaTransaction: function(),
    setChunk: function()
}
```
This JSON-RPC API implements the following functions:

* `getPlasmaBalance(address bytes20, blockNumber uint64)` - get a list of tokenIDs, denominations, and total balance owned by address(account).  This might go into a "Wallet" abstraction, to start up your own token list, where any tokenID in the Wallet could be verified.

```
> plasma.getPlasmaBalance("0x3088666E05794d2498D9d98326c1b426c9950767", 1);
{
    balance: 2000000000000000000,
    denomination: 2000000000000000000,
    tokens: ["0xb76883d225414136"]
}

curl -X POST --data  '{"jsonrpc":"2.0","id":"1","method":"plasma_getPlasmaBalance","params":["0x3088666E05794d2498D9d98326c1b426c9950767","0x1"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "1",
    "result": {
        "account": {
            "tokens": ["0xb76883d225414136"],
            "denomination": "0x1bc16d674ec80000",
            "balance": "0x1bc16d674ec80000"
        }
    }
}
```


* `getPlasmaToken(tokenID uint64, blockNumber uint64)` - get token by tokenID and targeted blockNumber. This can used by a node to verify token ownership when receiving a token from sender.

```
> plasma.getPlasmaToken("0x37b01bd3adfc4ef3" , 1)
{
    allowance: 0,
    balance: 1000000000000000000,
    denomination: 1000000000000000000,
    owner: "0x82da88c31e874c678d529ad51e43de3a4baf3914",
    prevBlock: 1,
    spent: 0
}

curl -X POST --data  '{"jsonrpc":"2.0","id":"2","method":"plasma_getPlasmaToken","params":["0x37b01bd3adfc4ef3","0x1"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "2",
    "result": {
        "token": {
            "denomination": "0xde0b6b3a7640000",
            "prevBlock": "0x1",
            "owner": "0x82da88c31e874c678d529ad51e43de3a4baf3914",
            "balance": "0xde0b6b3a7640000",
            "allowance": "0x0",
            "spent": "0x0"
        }
    }
}

*Note: TokenInfo SMT trie is not exposed to external API
```

* `getPlasmaBlock(blockNumber uint64)` - get Plasma BlockInfo by blockNumber. Every Plasma block contains rootHash for each tries, which can be used to verify state transition and incoming token transfer. {`tokenRoot`, `accountRoot`, `l3ChainRoot`} are persisted roots that contain the latest full state, whereas {`transactionRoot`,`anchorRoot`} are built independently and sparse at every block. An empty SMT trie will have Root: `0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff` as level 64 DefaultHash.

```
> plasma.getPlasmaBlock("0x1")
{
  block: {
    accountRoot: "0xea57cc53a6c26fd29dbaa385138f50d9030471222cf679fa88a7274a84870bbb",
    anchorRoot: "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
    blockNumber: "0x1",
    bloomID: "0x21fbaff17bd372e965d29f76026d63a6511187fd14c791acae9600079626edb0",
    headerHash: "0xd14908cd79e370e4e885723cc1c9dae26c01ab3a227b14278ae989a9afa7d822",
    l3ChainRoot: "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
    parentHash: "0x0000000000000000000000000000000000000000000000000000000000000000",
    sig: "0x1df1f4c3ff9416e6c91b37c2d4052a0f3bed4075c77d0d8751076c11a3e0c44108e5c094d5720034823812ff3e42475a94bd6d13c067780d640bb9e5fd72cf7000",
    time: "0x5b85da89",
    tokenRoot: "0x3d3419dee60f8cc5a0130ed16b09561bdd41b6799245e26ffa43544269a4bebc",
    transactionRoot: "0x5348248ba49f2802573cf7a942f24ab2cc330f0ec1e9113e121cd049833bbea5"
  }
}

curl -X POST --data  '{"jsonrpc":"2.0","id":"3","method":"plasma_getPlasmaBlock","params":["0x1"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "3",
    "result": {
        "block": {
            "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "blockNumber": "0x1",
            "time": "0x5b85da89",
            "bloomID": "0x21fbaff17bd372e965d29f76026d63a6511187fd14c791acae9600079626edb0",
            "transactionRoot": "0x5348248ba49f2802573cf7a942f24ab2cc330f0ec1e9113e121cd049833bbea5",
            "tokenRoot": "0x3d3419dee60f8cc5a0130ed16b09561bdd41b6799245e26ffa43544269a4bebc",
            "accountRoot": "0xea57cc53a6c26fd29dbaa385138f50d9030471222cf679fa88a7274a84870bbb",
            "l3ChainRoot": "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
            "anchorRoot": "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
            "sig": "0x1df1f4c3ff9416e6c91b37c2d4052a0f3bed4075c77d0d8751076c11a3e0c44108e5c094d5720034823812ff3e42475a94bd6d13c067780d640bb9e5fd72cf7000",
            "headerHash": "0xd14908cd79e370e4e885723cc1c9dae26c01ab3a227b14278ae989a9afa7d822"
        }
    }
}

*Note: For speed optimization, Block Body is not queried nor returned by external API
```

* `getPlasmaBloomFilter(bloomID bytes32)` - get Bloom Filter by bloomID. Bloom Filter is required for a node to efficiently validate token transfers.

```
> plasma.getPlasmaBloomFilter("0x21fbaff17bd372e965d29f76026d63a6511187fd14c791acae9600079626edb0")
{
    filter: "00000000000000000000000000000010..."
}

curl -X POST --data  '{"jsonrpc":"2.0","id":"4","method":"plasma_getPlasmaBloomFilter","params":["0x21fbaff17bd372e965d29f76026d63a6511187fd14c791acae9600079626edb0"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "4",
    "result": {
        "filter": "00000000000000000000000000000010..."
    }
}
```

* `getPlasmaTransactionReceipt(txHash bytes32)`  - get transaction Info {receipt, transaction, included blockNumber} by txHash. The receipt can be used to check whether a transaction actually was successful; pending transaction will have receipt status of `0` until it's mined. The sender could send this back to the recipient, or the recipient could simply call the API to retrieve transaction status themselves.

```
> plasma.getPlasmaTransactionReceipt("0x5b61f8311258e43fcb0f62ceba463a65d0c70f574956f91d197c1e2fcf1ddbc2");
{
    blockNumber: 1,
    plasmatransaction: {
        allowance: "0x0",
        denomination: "0xde0b6b3a7640000",
        depositIndex: "0x1",
        prevBlock: "0x0",
        prevOwner: "0xa45b77a98e2b840617e2ec6ddfbf71403bdcb683",
        recipient: "0x82da88c31e874c678d529ad51e43de3a4baf3914",
        sig: "0x70c92c528ce24447127210425f1ede95f4adb3425ba96794243f656f68d4f9d10608e256118a1279fa6624dc4b9fa086664329ca0dc4a8c6f66c3d96a868258d00",
        spent: "0x0",
        tokenID: "0x37b01bd3adfc4ef3"
    },
    receipt: 1
}

curl -X POST --data  '{"jsonrpc":"2.0","id":"5","method":"plasma_getPlasmaTransactionReceipt","params":["0x5b61f8311258e43fcb0f62ceba463a65d0c70f574956f91d197c1e2fcf1ddbc2"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "5",
    "result": {
        "plasmatransaction": {
            "tokenID": "0x37b01bd3adfc4ef3",
            "denomination": "0xde0b6b3a7640000",
            "depositIndex": "0x1",
            "prevBlock": "0x0",
            "prevOwner": "0xa45b77a98e2b840617e2ec6ddfbf71403bdcb683",
            "recipient": "0x82da88c31e874c678d529ad51e43de3a4baf3914",
            "allowance": "0x0",
            "spent": "0x0",
            "sig": "0x70c92c528ce24447127210425f1ede95f4adb3425ba96794243f656f68d4f9d10608e256118a1279fa6624dc4b9fa086664329ca0dc4a8c6f66c3d96a868258d00"
        },
        "blockNumber": 1,
        "receipt": 1
    }
}
```

* `getPlasmaTransactionProof(txHash bytes32)` - get inclusion proof { blockNumber, txbyte, proofByte } by txHash. An inclusion proof is required to start exit or challenge double spend on MainNet.

```
> plasma.getPlasmaTransactionProof("0x5b61f8311258e43fcb0f62ceba463a65d0c70f574956f91d197c1e2fcf1ddbc2");
{
    blockNumber: "0x1",
    proofByte: "0xe0000000000000004416e8b81b687374a7705bd58f1aa122c917ed5f311b747f5e984922c4f8eed8c7a1596cabe958de0d77ae76d680905f8c23bb85bba7bb564e9ebb9fb7f257097d11460cd0890531370a9f5a5827ce98ec42c947bf5c867cf800d5c66a955a72",
    tokenID: "0x37b01bd3adfc4ef3",
    txbyte: "0xf8838837b01bd3adfc4ef3880de0b6b3a7640000018094a45b77a98e2b840617e2ec6ddfbf71403bdcb6839482da88c31e874c678d529ad51e43de3a4baf39148080b84170c92c528ce24447127210425f1ede95f4adb3425ba96794243f656f68d4f9d10608e256118a1279fa6624dc4b9fa086664329ca0dc4a8c6f66c3d96a868258d00"
}

curl -X POST --data  '{"jsonrpc":"2.0","id":"6","method":"plasma_getPlasmaTransactionProof","params":["0x5b61f8311258e43fcb0f62ceba463a65d0c70f574956f91d197c1e2fcf1ddbc2"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "6",
    "result": {
        "blockNumber": "0x1",
        "proofByte": "0xe0000000000000004416e8b81b687374a7705bd58f1aa122c917ed5f311b747f5e984922c4f8eed8c7a1596cabe958de0d77ae76d680905f8c23bb85bba7bb564e9ebb9fb7f257097d11460cd0890531370a9f5a5827ce98ec42c947bf5c867cf800d5c66a955a72",
        "tokenID": "0x37b01bd3adfc4ef3",
        "txbyte": "0xf8838837b01bd3adfc4ef3880de0b6b3a7640000018094a45b77a98e2b840617e2ec6ddfbf71403bdcb6839482da88c31e874c678d529ad51e43de3a4baf39148080b84170c92c528ce24447127210425f1ede95f4adb3425ba96794243f656f68d4f9d10608e256118a1279fa6624dc4b9fa086664329ca0dc4a8c6f66c3d96a868258d00"
    }
}
```

## Plasma Transaction
When one node sends a Plasma token to another:

1. To make plasma cash "usable", we have implemented `tokenStorage trie` that keeps tracks of every token's state transition in a persisted SMT tree. This enables sender to submit `sendPlasmaTransaction` without the need of providing the entire token history as inputs.  A plasma node will relay `sendPlasmaTransaction` request to its peers via `BroadcastPlasmaTransaction`, one of whom will be the leader (authority). leader (authority) verifies a transaction via the `tokenRoot` and will run `MintPlasmaBlock` within few seconds (e.g. after 5 seconds, or after 1000 transactions, whichever comes first). While pending transaction sits in the transaction pool, txHash is returned back to the sender immediately. Calling `getPlasmaTransactionReceipt` will return status `0` until the tx is mined.

2. New Blocks are created _after_ leader (authority) uses the `PlasmaChunkstore` abstraction to verifiably store chunks among different cloudstores. leader (authority) will then transmit `BroadcastBlock` event to all the plasma nodes and update `PlasmaTransactionReceip` status to `1`.
If all are successful, leader (authority) will publish `transactionRoot` and `blockNumber` to MainNet via `submitBlock`.

3. The sender, having seen its transaction "cleared" with the plasma operator (and seeing that it has a "proof of inclusion" on MainNet), can then send a "proof" to its fellow node by calling `getPlasmaTransactionProof` and sending the data with its own _SWAP_ protocol.  The recipient will then:
 * calling `getPlasmaTransactionReceipt` itself, retrieving the transaction
 * check the signature matches the sender
 * check the transaction has been included in the block by calling MainNet for the proof (this is free!)
 * download all Bloom filters, all the way back to the previous checkpoint
 * For false-positive case in Bloom filters or non-empty blocks, check for token history.
 * update its own Wallet


IMPORTANT: While transaction can be initiated without full token history, token owners should still keep the full history _independent from plasma operator_ to protect themselves against malicious operator.


* `sendPlasmaTransaction(plasmaTX)` - requires PlasmaTransaction type as input. This function can be called by token owners to Initiate token transfer:

```
# PlasmaTransaction Type
{
    "tokenID": uint64,
    "denomination": uint64,
    "depositIndex": uint64,
    "prevBlock": uint64,
    "prevOwner": address(bytes20),
    "recipient": address(bytes20),
    "allowance": uint64,
    "spent": uint64,
    "balance": uint64,
    "sig": bytes ([r,s,v], length 65)
}

Note: balance field is optional
```

```
# Initiate a Plasma Transaction on Layer 2
> plasma.sendPlasmaTransaction({"tokenID":0x37b01bd3adfc4ef3, "denomination": 1000000000000000000, "depositIndex": 1, "prevBlock": 1, "prevOwner": "0x82Da88C31E874C678D529ad51E43De3A4BAF3914", "recipient": "0x3088666E05794d2498D9d98326c1b426c9950767", "allowance": 100000000000000001, "spent": 200000000000000002, "sig": "0x3c2008edcd3292184c796706f2465ffd5442a119b59acca04695487c18bb21db0e20782658a00455e911ac0530bfb2a0817451e75a133c12a540b567f1f6e1ae01"});
"0xd34a83cd0e7fe772bd81e4d1812b9529c5bd1c85dceda4b0e9b79e7cdcc96409"

# Query PlasmaTransactionReceipt
> plasma.getPlasmaTransactionReceipt("0xd34a83cd0e7fe772bd81e4d1812b9529c5bd1c85dceda4b0e9b79e7cdcc96409")
{
  blockNumber: 2,
  plasmatransaction: {
    allowance: "0x16345785d8a0001",
    denomination: "0xde0b6b3a7640000",
    depositIndex: "0x1",
    prevBlock: "0x1",
    prevOwner: "0x82da88c31e874c678d529ad51e43de3a4baf3914",
    recipient: "0x3088666e05794d2498d9d98326c1b426c9950767",
    sig: "0x3c2008edcd3292184c796706f2465ffd5442a119b59acca04695487c18bb21db0e20782658a00455e911ac0530bfb2a0817451e75a133c12a540b567f1f6e1ae01",
    spent: "0x2c68af0bb140002",
    tokenID: "0x37b01bd3adfc4ef3"
  },
  receipt: 1
}

# Retrieve Token State from Block #2
> plasma.getPlasmaToken("0x37b01bd3adfc4ef3", 2)
{
    allowance: 100000000000000001,
    balance: 699999999999999997,
    denomination: 1000000000000000000,
    owner: "0x3088666e05794d2498d9d98326c1b426c9950767",
    prevBlock: 2,
    spent: 200000000000000002
}

# Retrieve Block #2
> plasma.getPlasmaBlock(2);
{
  block: {
    accountRoot: "0x5c237e0b259471155074e667da1674037fd1b0ef0220063e524940b07d3f503f",
    anchorRoot: "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
    blockNumber: "0x2",
    bloomID: "0xda0f9b66e614309fead8740a3f318fd4864a09462753b0db8ae5004c7d7bfa68",
    headerHash: "0x77865b5b9e4fca5dae894420b759502ad8d8592595b97a27612fa0e3fda19864",
    l3ChainRoot: "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
    parentHash: "0x2e9c63ebf208d991782d79da7787fd5c297b1da78f3022cb585a49b5a3f4af98",
    sig: "0x2c4a0300fd61209f741658e2c8176ecd08b3c75667f521dd79f98ec84c0e8bdc23d23744571b81b1b823c89963413f85b842a69af3e8257bf2d1654ce72548fd00",
    time: "0x5b85dae7",
    tokenRoot: "0x5b7bc99a32e5a82ce4dd99aa0846a3cf5aa022e9a3c9e92237671b019c7f401d",
    transactionRoot: "0x7f01ead7c6ede63b005e01625dd2cdb92d6535fb6eea072255cd6051393d54f9"
  }
}

# Retrieve Transaction Proof
> plasma.getPlasmaTransactionProof("0xd34a83cd0e7fe772bd81e4d1812b9529c5bd1c85dceda4b0e9b79e7cdcc96409");
{
    blockNumber: "0x2",
    proofByte: "0x0000000000000000",
    tokenID: "0x37b01bd3adfc4ef3",
    txbyte: "0xf8938837b01bd3adfc4ef3880de0b6b3a764000001019482da88c31e874c678d529ad51e43de3a4baf3914943088666e05794d2498d9d98326c1b426c995076788016345785d8a00018802c68af0bb140002b8413c2008edcd3292184c796706f2465ffd5442a119b59acca04695487c18bb21db0e20782658a00455e911ac0530bfb2a0817451e75a133c12a540b567f1f6e1ae01"
}

# Retrieve PlasmaBalance
plasma.getPlasmaBalance("0x3088666E05794d2498D9d98326c1b426c9950767", 2);
{
    balance: 2699999999999999997,
    denomination: 3000000000000000000,
    tokens: ["0xb76883d225414136", "0x37b01bd3adfc4ef3"]
}
```

```
# Initiate a Plasma Transaction on Layer 2
curl -X POST --data '{"jsonrpc":"2.0","id":"7","method":"plasma_sendPlasmaTransaction","params":[{"tokenID":"0x37b01bd3adfc4ef3", "denomination": "0xde0b6b3a7640000", "depositIndex": "0x1", "prevBlock": "0x1", "prevOwner": "0x82Da88C31E874C678D529ad51E43De3A4BAF3914", "recipient": "0x3088666E05794d2498D9d98326c1b426c9950767", "allowance": "0x16345785d8a0001", "spent": "0x2c68af0bb140002", "sig": "0x3c2008edcd3292184c796706f2465ffd5442a119b59acca04695487c18bb21db0e20782658a00455e911ac0530bfb2a0817451e75a133c12a540b567f1f6e1ae01"}]}' -H 'content-type:application/json;' 'localhost:8502'
{
    "jsonrpc": "2.0",
    "id": "7",
    "result": "0xd34a83cd0e7fe772bd81e4d1812b9529c5bd1c85dceda4b0e9b79e7cdcc96409"
}

# Query PlasmaTransactionReceipt
curl -X POST --data  '{"jsonrpc":"2.0","id":"8","method":"plasma_getPlasmaTransactionReceipt","params":["0xd34a83cd0e7fe772bd81e4d1812b9529c5bd1c85dceda4b0e9b79e7cdcc96409"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "8",
    "result": {
        "plasmatransaction": {
            "tokenID": "0x37b01bd3adfc4ef3",
            "denomination": "0xde0b6b3a7640000",
            "depositIndex": "0x1",
            "prevBlock": "0x1",
            "prevOwner": "0x82da88c31e874c678d529ad51e43de3a4baf3914",
            "recipient": "0x3088666e05794d2498d9d98326c1b426c9950767",
            "allowance": "0x16345785d8a0001",
            "spent": "0x2c68af0bb140002",
            "sig": "0x3c2008edcd3292184c796706f2465ffd5442a119b59acca04695487c18bb21db0e20782658a00455e911ac0530bfb2a0817451e75a133c12a540b567f1f6e1ae01"
        },
        "blockNumber": 2,
        "receipt": 1
    }
}

# Retrieve Token State from Block #2
curl -X POST --data  '{"jsonrpc":"2.0","id":"9","method":"plasma_getPlasmaToken","params":["0x37b01bd3adfc4ef3","0x2"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "9",
    "result": {
        "token": {
            "denomination": "0xde0b6b3a7640000",
            "prevBlock": "0x3",
            "owner": "0x3088666e05794d2498d9d98326c1b426c9950767",
            "balance": "0x9b6e64a8ec5fffd",
            "allowance": "0x16345785d8a0001",
            "spent": "0x2c68af0bb140002"
        }
    }
}

# Retrieve Block #2
curl -X POST --data  '{"jsonrpc":"2.0","id":"10","method":"plasma_getPlasmaBlock","params":["0x2"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "10",
    "result": {
        "block": {
            "parentHash": "0x2e9c63ebf208d991782d79da7787fd5c297b1da78f3022cb585a49b5a3f4af98",
            "blockNumber": "0x2",
            "time": "0x5b85dae7",
            "bloomID": "0xda0f9b66e614309fead8740a3f318fd4864a09462753b0db8ae5004c7d7bfa68",
            "transactionRoot": "0x7f01ead7c6ede63b005e01625dd2cdb92d6535fb6eea072255cd6051393d54f9",
            "tokenRoot": "0x5b7bc99a32e5a82ce4dd99aa0846a3cf5aa022e9a3c9e92237671b019c7f401d",
            "accountRoot": "0x5c237e0b259471155074e667da1674037fd1b0ef0220063e524940b07d3f503f",
            "l3ChainRoot": "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
            "anchorRoot": "0xb992a50058a2812b0fc4fe1bbbfb3d8ffd476fb89391408212e00a7019e10eff",
            "sig": "0x2c4a0300fd61209f741658e2c8176ecd08b3c75667f521dd79f98ec84c0e8bdc23d23744571b81b1b823c89963413f85b842a69af3e8257bf2d1654ce72548fd00",
            "headerHash": "0x77865b5b9e4fca5dae894420b759502ad8d8592595b97a27612fa0e3fda19864"
        }
    }
}

# Retrieve Transaction Proof
curl -X POST --data  '{"jsonrpc":"2.0","id":"11","method":"plasma_getPlasmaTransactionProof","params":["0xd34a83cd0e7fe772bd81e4d1812b9529c5bd1c85dceda4b0e9b79e7cdcc96409"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "11",
    "result": {
        "blockNumber": "0x2",
        "proofByte": "0x0000000000000000",
        "tokenID": "0x37b01bd3adfc4ef3",
        "txbyte": "0xf8938837b01bd3adfc4ef3880de0b6b3a764000001019482da88c31e874c678d529ad51e43de3a4baf3914943088666e05794d2498d9d98326c1b426c995076788016345785d8a00018802c68af0bb140002b8413c2008edcd3292184c796706f2465ffd5442a119b59acca04695487c18bb21db0e20782658a00455e911ac0530bfb2a0817451e75a133c12a540b567f1f6e1ae01"
    }
}

# Retrieve PlasmaBalance
curl -X POST --data  '{"jsonrpc":"2.0","id":"12","method":"plasma_getPlasmaBalance","params":["0x3088666E05794d2498D9d98326c1b426c9950767","0x2"]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "12",
    "result": {
        "account": {
            "tokens": [
                "0xb76883d225414136",
                "0x37b01bd3adfc4ef3"
            ],
            "denomination": "0x29a2241af62c0000",
            "balance": "0x257853b1dd8dfffd"
        }
    }
}
```




## Anchor Transaction

* BlockchainID Assignment - A valid token is required to create Layer 3 blockchain. Layer 3 blockchainID is automatically assigned using the last 8 bytes of  `Keccak256(tokenID, blockchainNonce)`.  For example, the first L3 chain created by `0x37b01bd3adfc4ef3` will have blockchainID `0x69eb463bc4f6b2df`, the last 8 bytes of `Keccak256(37b01bd3adfc4ef3,0)`

* `sendAnchorTransaction(AnchorTX)` - requires AnchorTransaction type as input. This function is called by Layer3 Chain operators to submit their blockhashes to plasma nodes. AnchorTransactions can also be used to modify Layer3 chain permission by passing in non-empty extra.

```
# AnchorTransaction Type
{
    "blockchainID": uint64,
    "blocknumber": uint64,
    "blockhash": bytes32,
    "extra":{"addedOwners": ["addr1", "addr2",...], "removedOwners": Array[Addr]},
    "sig": bytes ([r,s,v], length 65)
}

WARNING: empty extra must be encoded as 'RLP([[],[]])' or 'c2c0c0' when there's no change for ownership
```


```
# Creates Layer3 Blockchain (AnchorTx with blocknumber #0)
> plasma.sendAnchorTransaction({"blockchainID":"0x69eb463bc4f6b2df","blocknumber":"0x0","blockhash":"0x03c85f1da84d9c6313e0c34bcb5ace945a9b12105988895252b88ce5b769f82b","sig":"0xae7742aafad0c710dcc206f1677c15a2057cc2cc55f6bf3fccba5ccecbdb5a9b71f0f36b0df9c534bf1aa52fc4e5e2fbb1a6d839f0d0b9eb461abb774970037901"})
"0x9922a9c18247ad9357e450d24cb9029a83772323a8f10a6b46c150ebc7ceb5ea"


# Add/Remove Owners for a Layer3 Blockchain (AnchorTx with non-empty extradata)
> plasma.sendAnchorTransaction({"blockchainID":"0x69eb463bc4f6b2df","blocknumber":"0x1","blockhash":"0x6d255fc3390ee6b41191da315958b7d6a1e5b17904cc7683558f98acc57977b4","extra":{"addedOwners":["0x3088666E05794d2498D9d98326c1b426c9950767"],"removedOwners":[]},"sig":"0x767b66becf65544073daa10991d94f77f05026e7df5338a6001a423d3b38b54540226bd08856a8aa684c4c1a0d6dd01e1d4262f22b45fcc2821505c395d2d1d801"})
"0x2236b658c5e00ba65cf7d8af8eec5492aae68ba88ec5ae0980d223fcd509bca9"
```
```
# Creates Layer3 Blockchain (AnchorTx with blocknumber #0)
curl -X POST --data  '{"jsonrpc":"2.0","id":"9","method":"plasma_sendAnchorTransaction","params":[{"blockchainID":"0x69eb463bc4f6b2df", "blocknumber":"0x0", "blockhash":"0x03c85f1da84d9c6313e0c34bcb5ace945a9b12105988895252b88ce5b769f82b", "sig":"0xae7742aafad0c710dcc206f1677c15a2057cc2cc55f6bf3fccba5ccecbdb5a9b71f0f36b0df9c534bf1aa52fc4e5e2fbb1a6d839f0d0b9eb461abb774970037901"}]}' -H 'content-type:application/json;' 'localhost:8502';
{
    "jsonrpc": "2.0",
    "id": "13",
    "result": "0x9922a9c18247ad9357e450d24cb9029a83772323a8f10a6b46c150ebc7ceb5ea"
}


# Add/Remove Owners for a Layer3 Blockchain (AnchorTx with non-empty extradata)
curl -X POST --data '{"jsonrpc":"2.0","id":"10","method":"plasma_sendAnchorTransaction","params":[{"blockchainID":"0x69eb463bc4f6b2df", "blocknumber":"0x1", "blockhash":"0x6d255fc3390ee6b41191da315958b7d6a1e5b17904cc7683558f98acc57977b4", "extra":{"addedOwners":["0x3088666E05794d2498D9d98326c1b426c9950767"],"removedOwners":[]}, "sig":"0x767b66becf65544073daa10991d94f77f05026e7df5338a6001a423d3b38b54540226bd08856a8aa684c4c1a0d6dd01e1d4262f22b45fcc2821505c395d2d1d801"}]}' -H'content-type:application/json;' 'localhost:8502'
{
    "jsonrpc": "2.0",
    "id": "14",
    "result": "0x2236b658c5e00ba65cf7d8af8eec5492aae68ba88ec5ae0980d223fcd509bca9"
}
```
